rule_id: win_PsExec_P_Flag
name: PsExec Used with -P flag.
description: >
    Detects use of PsExec with the -P flag, indicating a password is being used in cleartext within the command line.
    This is a potential indicator of privilege escalation or lateral movement.
type: eql
language: eql 

query: |
  process where
    (
      process.name in ("psexec.exe", "psexec64.exe", "PsExec.exe", "PsExec64.exe", "PSEXEC.EXE", "PSEXEC64.EXE") or
      stringContains(process.command_line, "psexec") or 
      stringContains(process.command_line, "PsExec") or
      stringContains(process.command_line, "PSEXEC")
    ) and
    (
    stringContains(process.command_line, " -p") or 
    stringContains(process.command_line, " -P")
    )

index: 
  - .ds-logs-endpoint.events.process-*
  - .ds-logs-windows.sysmon-*
  - .ds-logs-system.security-*
  - .ds-logs-windows.powershell-*

severity: high
risk_score: 80

enabled: true

tags: 
  - attack.lateral_movement
  - tool.psexec
  - attack.T1021

references: 
  - https://learn.microsoft.com/en-us/sysinternals/downloads/psexec
  - https://attack.mitre.org/techniques/T1021

author: 
  - Gabriel_binion
version: 1.0
interval: 2m
from: now-24h

