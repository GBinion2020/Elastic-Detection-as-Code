rule_id: win_PsExec_P_Flag
name: PsExec Used with -P flag.
description: >
    Detects use of PsExec with the -P flag, indicating a password is being used in cleartext within the command line.
    This is a potential indicator of privilege escalation or lateral movement.
type: eql
language: eql 

query: |
  process where
    (
      process.name in ("psexec.exe", "psexec64.exe", "Psexec.exe", "Psexec64.exe") or
      stringContains(process.command_line, "psexec") or 
      stringContains(process.command_line, "Psexec") or
      stringContains(process.command_line, "psexec.exe") or 
      stringContains(process.command_line, "Psexec.exe")
    ) and
    (
    stringContains(process.command_line, " -P ") or 
    stringContains(process.command_line, " -p ")
    )

index: 
  - logs-endpoint.events.process-*
  - logs-windows.sysmon-*
  - logs-system.security-*
  - logs-windows.powershell-*

severity: high
risk_score: 80

enabled: true

tags: 
  - attack.lateral_movement
  - tool.psexec
  - attack.T1021

references: 
  - https://learn.microsoft.com/en-us/sysinternals/downloads/psexec
  - https://attack.mitre.org/techniques/T1021

author: Gabriel_binion
version: 1.0
interval: 2m
from: now-24h

